<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zus Coffee Chat API Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .chat-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .panel-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .panel-subtitle {
            color: #666;
            font-size: 0.9em;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
            min-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .bot-message {
            background: #e9ecef;
            color: #333;
            margin-right: auto;
        }

        .system-message {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            font-style: italic;
            max-width: 100%;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            text-align: center;
            max-width: 100%;
        }

        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            border-color: #007bff;
        }

        .send-button {
            padding: 12px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .send-button:hover:not(:disabled) {
            background: #0056b3;
        }

        .send-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-button {
            padding: 8px 15px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-button:hover {
            background: #007bff;
            color: white;
        }

        .session-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #0066cc;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        .status-connecting {
            background: #ffc107;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .tool-metadata {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
            font-size: 12px;
            color: #6c757d;
        }

        .tool-call {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
        }

        .tool-name {
            font-weight: bold;
            color: #1976d2;
        }

        .tool-args {
            margin: 4px 0;
            font-family: monospace;
            background: #f5f5f5;
            padding: 4px;
            border-radius: 3px;
        }

        .tool-sql {
            margin: 4px 0;
            font-family: monospace;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 6px;
            border-radius: 3px;
            color: #856404;
        }

        .tool-sql code {
            background: transparent;
            color: #856404;
            font-weight: bold;
        }

        .typing-indicator {
            display: none;
            color: #666;
            font-style: italic;
            padding: 10px;
        }

        .typing-indicator.show {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .chat-panel {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Regular Chat Panel -->
        <div class="chat-panel">
            <div class="panel-header">
                <div class="panel-title">Regular Chat</div>
                <div class="panel-subtitle">Standard request/response chat</div>
            </div>
            
            <div class="session-info" id="regular-session-info">
                Session: Not started
            </div>
            
            <div class="chat-messages" id="regular-messages"></div>
            
            <div class="input-area">
                <input type="text" class="message-input" id="regular-input" 
                       placeholder="Type your message..." maxlength="1000">
                <button class="send-button" id="regular-send">Send</button>
            </div>
            
            <div class="controls">
                <button class="control-button" id="regular-clear">Clear Chat</button>
                <button class="control-button" id="regular-new-session">New Session</button>
                <span class="status-indicator status-disconnected" id="regular-status"></span>
                <span>Regular API</span>
            </div>
        </div>

        <!-- Streaming Chat Panel -->
        <div class="chat-panel">
            <div class="panel-header">
                <div class="panel-title">Streaming Chat</div>
                <div class="panel-subtitle">Real-time streaming with SSE</div>
            </div>
            
            <div class="session-info" id="stream-session-info">
                Session: Not started
            </div>
            
            <div class="chat-messages" id="stream-messages"></div>
            
            <div class="typing-indicator" id="typing-indicator">
                Bot is typing...
            </div>
            
            <div class="input-area">
                <input type="text" class="message-input" id="stream-input" 
                       placeholder="Type your message..." maxlength="1000">
                <button class="send-button" id="stream-send">Send</button>
            </div>
            
            <div class="controls">
                <button class="control-button" id="stream-clear">Clear Chat</button>
                <button class="control-button" id="stream-new-session">New Session</button>
                <button class="control-button" id="stream-stop">Stop Stream</button>
                <span class="status-indicator status-disconnected" id="stream-status"></span>
                <span>Streaming API</span>
            </div>
        </div>
    </div>

    <script>
        class ChatTester {
            constructor() {
                this.baseUrl = 'http://localhost:8000';
                this.regularSessionId = null;
                this.streamSessionId = null;
                this.currentEventSource = null;
                this.isStreaming = false;
                
                this.initializeEventListeners();
                this.updateStatus('regular', 'disconnected');
                this.updateStatus('stream', 'disconnected');
            }

            initializeEventListeners() {
                // Regular chat
                document.getElementById('regular-send').addEventListener('click', () => this.sendRegularMessage());
                document.getElementById('regular-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendRegularMessage();
                });
                document.getElementById('regular-clear').addEventListener('click', () => this.clearMessages('regular'));
                document.getElementById('regular-new-session').addEventListener('click', () => this.newSession('regular'));

                // Streaming chat
                document.getElementById('stream-send').addEventListener('click', () => this.sendStreamMessage());
                document.getElementById('stream-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendStreamMessage();
                });
                document.getElementById('stream-clear').addEventListener('click', () => this.clearMessages('stream'));
                document.getElementById('stream-new-session').addEventListener('click', () => this.newSession('stream'));
                document.getElementById('stream-stop').addEventListener('click', () => this.stopStream());

                // Test connection on load
                this.testConnection();
            }

            async testConnection() {
                try {
                    const response = await fetch(`${this.baseUrl}/docs`);
                    if (response.ok) {
                        this.updateStatus('regular', 'connected');
                        this.updateStatus('stream', 'connected');
                        this.addSystemMessage('regular', 'Connected to API server');
                        this.addSystemMessage('stream', 'Connected to API server');
                    }
                } catch (error) {
                    this.updateStatus('regular', 'disconnected');
                    this.updateStatus('stream', 'disconnected');
                    this.addSystemMessage('regular', 'Failed to connect to API server');
                    this.addSystemMessage('stream', 'Failed to connect to API server');
                }
            }

            updateStatus(type, status) {
                const statusElement = document.getElementById(`${type}-status`);
                statusElement.className = `status-indicator status-${status}`;
            }

            updateSessionInfo(type, sessionId) {
                const sessionElement = document.getElementById(`${type}-session-info`);
                sessionElement.textContent = sessionId ? `Session: ${sessionId}` : 'Session: Not started';
            }

            addMessage(type, content, isUser = false, isSystem = false, isError = false, toolCalls = null) {
                const messagesContainer = document.getElementById(`${type}-messages`);
                const messageDiv = document.createElement('div');
                
                if (isSystem) {
                    messageDiv.className = 'message system-message';
                } else if (isError) {
                    messageDiv.className = 'message error-message';
                } else if (isUser) {
                    messageDiv.className = 'message user-message';
                } else {
                    messageDiv.className = 'message bot-message';
                }
                
                messageDiv.textContent = content;
                
                // Add tool metadata if available
                if (toolCalls && toolCalls.length > 0) {
                    const toolMetadataDiv = document.createElement('div');
                    toolMetadataDiv.className = 'tool-metadata';
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.innerHTML = `<strong>ðŸ”§ Tool Calls (${toolCalls.length}):</strong>`;
                    toolMetadataDiv.appendChild(titleDiv);
                    
                    toolCalls.forEach((tool, index) => {
                        const toolCallDiv = document.createElement('div');
                        toolCallDiv.className = 'tool-call';
                        
                        const toolNameDiv = document.createElement('div');
                        toolNameDiv.className = 'tool-name';
                        toolNameDiv.textContent = `${index + 1}. ${tool.tool_name}`;
                        toolCallDiv.appendChild(toolNameDiv);
                        
                        if (tool.tool_kwargs && Object.keys(tool.tool_kwargs).length > 0) {
                            const argsDiv = document.createElement('div');
                            argsDiv.className = 'tool-args';
                            argsDiv.innerHTML = `<strong>Args:</strong> ${JSON.stringify(tool.tool_kwargs, null, 2)}`;
                            toolCallDiv.appendChild(argsDiv);
                        }
                        
                        if (tool.tool_args && tool.tool_args.length > 0) {
                            const posArgsDiv = document.createElement('div');
                            posArgsDiv.className = 'tool-args';
                            posArgsDiv.innerHTML = `<strong>Positional Args:</strong> ${JSON.stringify(tool.tool_args, null, 2)}`;
                            toolCallDiv.appendChild(posArgsDiv);
                        }
                        
                        // Show generated SQL if available
                        if (tool.generated_sql) {
                            const sqlDiv = document.createElement('div');
                            sqlDiv.className = 'tool-sql';
                            sqlDiv.innerHTML = `<strong>Generated SQL:</strong> <code>${tool.generated_sql}</code>`;
                            toolCallDiv.appendChild(sqlDiv);
                        }
                        
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'tool-result';
                        const resultText = typeof tool.result === 'object' ? JSON.stringify(tool.result, null, 2) : String(tool.result);
                        resultDiv.innerHTML = `<strong>Result:</strong> ${resultText}`;
                        toolCallDiv.appendChild(resultDiv);
                        
                        toolMetadataDiv.appendChild(toolCallDiv);
                    });
                    
                    messageDiv.appendChild(toolMetadataDiv);
                }
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            addSystemMessage(type, content) {
                this.addMessage(type, content, false, true, false);
            }

            addErrorMessage(type, content) {
                this.addMessage(type, content, false, false, true);
            }

            clearMessages(type) {
                const messagesContainer = document.getElementById(`${type}-messages`);
                messagesContainer.innerHTML = '';
            }

            newSession(type) {
                if (type === 'regular') {
                    this.regularSessionId = null;
                } else {
                    this.streamSessionId = null;
                }
                this.updateSessionInfo(type, null);
                this.addSystemMessage(type, 'Starting new session...');
            }

            async sendRegularMessage() {
                const input = document.getElementById('regular-input');
                const sendButton = document.getElementById('regular-send');
                const message = input.value.trim();
                
                if (!message) return;

                // Disable input while processing
                input.disabled = true;
                sendButton.disabled = true;
                this.updateStatus('regular', 'connecting');

                // Add user message to chat
                this.addMessage('regular', message, true);
                input.value = '';

                try {
                    const response = await fetch(`${this.baseUrl}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            session_id: this.regularSessionId
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Update session ID if new
                    if (data.session_id !== this.regularSessionId) {
                        this.regularSessionId = data.session_id;
                        this.updateSessionInfo('regular', this.regularSessionId);
                    }

                    // Add bot response with tool metadata
                    this.addMessage('regular', data.response, false, false, false, data.tool_calls);
                    this.updateStatus('regular', 'connected');

                } catch (error) {
                    console.error('Error sending regular message:', error);
                    this.addErrorMessage('regular', `Error: ${error.message}`);
                    this.updateStatus('regular', 'disconnected');
                } finally {
                    // Re-enable input
                    input.disabled = false;
                    sendButton.disabled = false;
                    input.focus();
                }
            }

            async sendStreamMessage() {
                const input = document.getElementById('stream-input');
                const sendButton = document.getElementById('stream-send');
                const message = input.value.trim();
                
                if (!message || this.isStreaming) return;

                // Disable input while streaming
                input.disabled = true;
                sendButton.disabled = true;
                this.isStreaming = true;
                this.updateStatus('stream', 'connecting');

                // Add user message to chat
                this.addMessage('stream', message, true);
                input.value = '';

                // Show typing indicator
                document.getElementById('typing-indicator').classList.add('show');

                try {
                    const response = await fetch(`${this.baseUrl}/chat-stream`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            session_id: this.streamSessionId
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let currentBotMessage = null;

                    this.updateStatus('stream', 'connected');

                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep incomplete line in buffer

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6).trim();
                                
                                if (data === '[DONE]') {
                                    // Stream completed
                                    document.getElementById('typing-indicator').classList.remove('show');
                                    this.isStreaming = false;
                                    input.disabled = false;
                                    sendButton.disabled = false;
                                    input.focus();
                                    return;
                                }

                                try {
                                    const chunk = JSON.parse(data);
                                    
                                    // Update session ID if provided
                                    if (chunk.session_id && chunk.session_id !== this.streamSessionId) {
                                        this.streamSessionId = chunk.session_id;
                                        this.updateSessionInfo('stream', this.streamSessionId);
                                    }

                                    if (chunk.chunk) {
                                        // Streaming chunk
                                        if (!currentBotMessage) {
                                            // Create new bot message element
                                            const messagesContainer = document.getElementById('stream-messages');
                                            currentBotMessage = document.createElement('div');
                                            currentBotMessage.className = 'message bot-message';
                                            messagesContainer.appendChild(currentBotMessage);
                                        }
                                        
                                        // Append chunk to current message
                                        currentBotMessage.textContent += chunk.chunk;
                                        
                                        // Scroll to bottom
                                        const messagesContainer = document.getElementById('stream-messages');
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                    }

                                    if (chunk.response && chunk.status === 'complete') {
                                        // Final complete response
                                        if (currentBotMessage) {
                                            currentBotMessage.textContent = chunk.response;
                                            
                                            // Add tool metadata if available
                                            if (chunk.tool_calls && chunk.tool_calls.length > 0) {
                                                const toolMetadataDiv = document.createElement('div');
                                                toolMetadataDiv.className = 'tool-metadata';
                                                
                                                const titleDiv = document.createElement('div');
                                                titleDiv.innerHTML = `<strong>ðŸ”§ Tool Calls (${chunk.tool_calls.length}):</strong>`;
                                                toolMetadataDiv.appendChild(titleDiv);
                                                
                                                chunk.tool_calls.forEach((tool, index) => {
                                                    const toolCallDiv = document.createElement('div');
                                                    toolCallDiv.className = 'tool-call';
                                                    
                                                    const toolNameDiv = document.createElement('div');
                                                    toolNameDiv.className = 'tool-name';
                                                    toolNameDiv.textContent = `${index + 1}. ${tool.tool_name}`;
                                                    toolCallDiv.appendChild(toolNameDiv);
                                                    
                                                    if (tool.tool_kwargs && Object.keys(tool.tool_kwargs).length > 0) {
                                                        const argsDiv = document.createElement('div');
                                                        argsDiv.className = 'tool-args';
                                                        argsDiv.innerHTML = `<strong>Args:</strong> ${JSON.stringify(tool.tool_kwargs, null, 2)}`;
                                                        toolCallDiv.appendChild(argsDiv);
                                                    }
                                                    
                                                    if (tool.tool_args && tool.tool_args.length > 0) {
                                                        const posArgsDiv = document.createElement('div');
                                                        posArgsDiv.className = 'tool-args';
                                                        posArgsDiv.innerHTML = `<strong>Positional Args:</strong> ${JSON.stringify(tool.tool_args, null, 2)}`;
                                                        toolCallDiv.appendChild(posArgsDiv);
                                                    }
                                                    
                                                    // Show generated SQL if available
                                                    if (tool.generated_sql) {
                                                        const sqlDiv = document.createElement('div');
                                                        sqlDiv.className = 'tool-sql';
                                                        sqlDiv.innerHTML = `<strong>Generated SQL:</strong> <code>${tool.generated_sql}</code>`;
                                                        toolCallDiv.appendChild(sqlDiv);
                                                    }
                                                    
                                                    const resultDiv = document.createElement('div');
                                                    resultDiv.className = 'tool-result';
                                                    const resultText = typeof tool.result === 'object' ? JSON.stringify(tool.result, null, 2) : String(tool.result);
                                                    resultDiv.innerHTML = `<strong>Result:</strong> ${resultText}`;
                                                    toolCallDiv.appendChild(resultDiv);
                                                    
                                                    toolMetadataDiv.appendChild(toolCallDiv);
                                                });
                                                
                                                currentBotMessage.appendChild(toolMetadataDiv);
                                            }
                                        } else {
                                            this.addMessage('stream', chunk.response, false, false, false, chunk.tool_calls);
                                        }
                                    }

                                    if (chunk.status === 'error') {
                                        this.addErrorMessage('stream', chunk.chunk || 'Stream error occurred');
                                    }

                                } catch (parseError) {
                                    console.warn('Failed to parse SSE data:', data);
                                }
                            }
                        }
                    }

                } catch (error) {
                    console.error('Error in stream:', error);
                    this.addErrorMessage('stream', `Stream error: ${error.message}`);
                    this.updateStatus('stream', 'disconnected');
                } finally {
                    // Clean up
                    document.getElementById('typing-indicator').classList.remove('show');
                    this.isStreaming = false;
                    input.disabled = false;
                    sendButton.disabled = false;
                    input.focus();
                }
            }

            stopStream() {
                if (this.currentEventSource) {
                    this.currentEventSource.close();
                    this.currentEventSource = null;
                }
                
                document.getElementById('typing-indicator').classList.remove('show');
                this.isStreaming = false;
                
                const input = document.getElementById('stream-input');
                const sendButton = document.getElementById('stream-send');
                input.disabled = false;
                sendButton.disabled = false;
                
                this.addSystemMessage('stream', 'Stream stopped by user');
            }
        }

        // Initialize the chat tester when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ChatTester();
        });
    </script>
</body>
</html>
